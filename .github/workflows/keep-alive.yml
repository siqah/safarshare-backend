name: Keep SafariShare Backend Alive

on:
  schedule:
    # Ping every 10 minutes (cron format: minute hour day month weekday)
    # This runs at minutes 0, 10, 20, 30, 40, 50 of every hour
    - cron: '*/10 * * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“ Ping SafariShare Backend
      run: |
        echo "ğŸš€ Starting keep-alive ping for SafariShare Backend..."
        echo "â° Current time: $(date)"
        
        # Primary keep-alive endpoint
        echo "ğŸ“¡ Pinging keep-alive endpoint..."
        response=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
          --max-time 30 \
          https://safarshare-backend.onrender.com/keep-alive)
        
        echo "ğŸ“Š Keep-alive response code: $response"
        
        if [ $response -eq 200 ]; then
          echo "âœ… Backend is alive and healthy!"
          
          # Get detailed status
          echo "ğŸ“‹ Getting detailed status..."
          curl -s -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
            --max-time 15 \
            https://safarshare-backend.onrender.com/keep-alive | \
            jq -r '"ğŸ• Uptime: " + .uptime.readable + " | ğŸ’¾ Memory: " + .memory.used + " | ğŸ”— Connections: " + (.connections|tostring)' || \
            echo "ğŸ“Š Status retrieved successfully"
            
        else
          echo "âš ï¸ Keep-alive failed with code: $response"
          echo "ğŸ”„ Attempting wake-up call..."
          
          # Try wake-up endpoint
          wake_response=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
            --max-time 60 \
            https://safarshare-backend.onrender.com/wake-up)
          
          echo "ğŸŒ… Wake-up response code: $wake_response"
          
          if [ $wake_response -eq 200 ]; then
            echo "âœ… Backend successfully awakened!"
          else
            echo "âŒ Wake-up failed. Backend may need manual intervention."
            
            # Try simple ping as last resort
            echo "ğŸ“ Trying simple ping..."
            ping_response=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: GitHub-Actions-KeepAlive/1.0" \
              --max-time 30 \
              https://safarshare-backend.onrender.com/ping)
            
            echo "ğŸ“ Ping response code: $ping_response"
          fi
        fi
        
        echo "ğŸ Keep-alive job completed at $(date)"

    - name: ğŸ“Š Verify Backend Health
      if: success()
      run: |
        echo "ğŸ” Performing health verification..."
        
        # Wait a moment for backend to be fully ready
        sleep 5
        
        # Test critical endpoints
        echo "ğŸ§ª Testing health endpoint..."
        health_status=$(curl -s -o /dev/null -w "%{http_code}" \
          --max-time 20 \
          https://safarshare-backend.onrender.com/api/health)
        
        echo "ğŸ¥ Health endpoint status: $health_status"
        
        if [ $health_status -eq 200 ]; then
          echo "âœ… All systems operational!"
        else
          echo "âš ï¸ Health check returned: $health_status"
        fi

    - name: ğŸ“ Log Summary
      if: always()
      run: |
        echo "======================================"
        echo "ğŸ¯ SafariShare Backend Keep-Alive Summary"
        echo "â° Execution time: $(date)"
        echo "ğŸŒ Target: https://safarshare-backend.onrender.com"
        echo "ğŸ”„ Next run: In 10 minutes"
        echo "======================================"